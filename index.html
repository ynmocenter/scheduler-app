<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام مواعيد المركز</title>
  <!-- استخدام Tailwind CSS للتنسيق البسيط -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- EmailJS SDK -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #F3F4F6;
      color: #1F2937;
      padding-bottom: 40px;
    }
    header {
      background-color: #059669;
      padding: 1rem;
      text-align: center;
      color: white;
    }
    h1 {
      font-size: 1.75rem;
    }
    section {
      background: white;
      padding: 1.25rem;
      margin: 1.5rem auto;
      border-radius: 0.5rem;
      max-width: 800px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }
    input, select, button {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.75rem;
      border: 1px solid #D1D5DB;
      border-radius: 0.375rem;
      outline: none;
    }
    input:focus, select:focus {
      border-color: #2563EB;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    button {
      background-color: #2563EB;
      color: white;
      font-weight: 600;
      transition: background-color 0.15s;
    }
    button:hover {
      background-color: #1E40AF;
    }
    .btn-small {
      background-color: #D97706;
      color: white;
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      transition: background-color 0.15s;
    }
    .btn-small:hover {
      background-color: #B45309;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #E5E7EB;
      padding: 0.75rem;
      text-align: center;
      font-size: 0.875rem;
    }
    th {
      background-color: #F3F4F6;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background-color: #FAFAFA;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>نظام مواعيد المركز</h1>
  </header>

  <!-- 1) إدارة الأخصائيين -->
  <section>
    <h2 class="text-xl font-semibold mb-4">1. إدارة الأخصائيين</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <div>
        <label for="newSpec">اسم الأخصائي</label>
        <input type="text" id="newSpec" placeholder="مثال: د. أحمد" />
      </div>
      <div>
        <label for="newSpecEmail">البريد الإلكتروني</label>
        <input type="email" id="newSpecEmail" placeholder="example@email.com"/>
      </div>
      <div>
        <label for="newSpecDays">أيام العمل</label>
        <input type="text" id="newSpecDays" placeholder="مثال: السبت،الأحد" />
      </div>
      <div>
        <label for="newSpecTimes">فترات العمل</label>
        <input type="text" id="newSpecTimes" placeholder="مثال: 1:00-1:40،1:40-2:20" />
      </div>
    </div>
    <div class="flex flex-col md:flex-row gap-2 mb-4">
      <button onclick="addSpec()">إضافة أخصائي جديد</button>
      <button onclick="loadSpecs()" class="btn-small">🔄 إعادة تحميل البيانات</button>
    </div>
    <div class="overflow-x-auto">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>الاسم</th>
            <th>البريد الإلكتروني</th>
            <th>أيام العمل</th>
            <th>فترات العمل</th>
            <th>حذف</th>
          </tr>
        </thead>
        <tbody id="specTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- 2) إدخال مواعيد الأطفال -->
  <section>
    <h2 class="text-xl font-semibold mb-4">2. إدخال مواعيد الأطفال</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <div>
        <label for="childName">اسم الطفل</label>
        <input type="text" id="childName" placeholder="مثال: ليلى" />
      </div>
      <div>
        <label for="day">اليوم</label>
        <select id="day">
          <option>السبت</option><option>الأحد</option><option>الاثنين</option>
          <option>الثلاثاء</option><option>الأربعاء</option><option>الخميس</option>
        </select>
      </div>
      <div>
        <label for="timeSlot">الفترة الزمنية</label>
        <select id="timeSlot">
          <option>1:00 - 1:40</option><option>1:40 - 2:20</option>
          <option>2:20 - 3:00</option><option>3:20 - 4:00</option>
          <option>4:00 - 4:40</option><option>4:40 - 5:20</option>
          <option>5:20 - 6:00</option><option>6:00 - 6:40</option>
          <option>6:40 - 7:20</option><option>7:20 - 8:00</option>
          <option>8:00 - 8:40</option><option>8:40 - 9:20</option>
        </select>
      </div>
      <div>
        <label for="subscription">نوع الاشتراك</label>
        <select id="subscription">
          <option>24 جلسة</option><option>36 جلسة</option><option>48 جلسة</option>
          <option>ساعة اختبار</option><option>ساعتين اختبار</option>
        </select>
      </div>
    </div>
    <div>
      <label>الأقسام المطلوبة:</label>
      <div class="checkbox-group">
        <label><input type="checkbox" class="dept-chk" value="تعديل سلوك" /> تعديل سلوك</label>
        <label><input type="checkbox" class="dept-chk" value="تخاطب" /> تخاطب</label>
        <label><input type="checkbox" class="dept-chk" value="تنمية مهارات" /> تنمية مهارات</label>
        <label><input type="checkbox" class="dept-chk" value="جلسة نفسية" /> جلسة نفسية</label>
        <label><input type="checkbox" class="dept-chk" value="اختبار ذكاء" /> اختبار ذكاء</label>
      </div>
    </div>
    <button onclick="addAppt()">حفظ موعد الطفل</button>
  </section>

  <!-- 3) عرض جدول المواعيد وإرسال البريد -->
  <section>
    <h2 class="text-xl font-semibold mb-4">3. جدول المواعيد</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label for="filterSpec">تصفية باسم الأخصائي</label>
        <input type="text" id="filterSpec" placeholder="مثال: أحمد" />
      </div>
      <div class="flex items-end gap-2">
        <button onclick="filterAppts()">تصفية</button>
        <button onclick="renderAppts()">عرض الجميع</button>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label for="specEmail">البريد الإلكتروني للأخصائي</label>
        <input type="email" id="specEmail" placeholder="ahmed@example.com" />
      </div>
      <div class="flex items-end">
        <button onclick="sendScheduleEmail()">إرسال جدول الأخصائي</button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>اسم الطفل</th>
            <th>اليوم</th>
            <th>الوقت</th>
            <th>القسم</th>
            <th>اشتراك</th>
            <th>أخصائي</th>
            <th>تعويض</th>
          </tr>
        </thead>
        <tbody id="apptTableBody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
  // تهيئة EmailJS
  emailjs.init('Ol1_k8IqKWQbPcbNv');

  // مصفوفتا البيانات في المتصفح
  let specialists = JSON.parse(localStorage.getItem('specs') || '[]');
  let appointments = JSON.parse(localStorage.getItem('appts') || '[]');

  // تحميل وعرض البيانات عند فتح الصفحة
  window.onload = () => {
    loadSpecs();
    renderAppts();
  };

  // ===== إدارة الأخصائيين =====
  function saveSpecs() {
    localStorage.setItem('specs', JSON.stringify(specialists));
    loadSpecs();
  }
  function loadSpecs() {
    const tbody = document.getElementById('specTableBody');
    tbody.innerHTML = '';
    specialists.forEach((s, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border p-2">${idx + 1}</td>
        <td class="border p-2">${s.name}</td>
        <td class="border p-2">${s.email}</td>
        <td class="border p-2">${s.days}</td>
        <td class="border p-2">${s.times}</td>
        <td class="border p-2">
          <button class="btn-small" onclick="deleteSpec(${idx})">حذف</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  function addSpec() {
    const name = document.getElementById('newSpec').value.trim();
    const email = document.getElementById('newSpecEmail').value.trim();
    const days = document.getElementById('newSpecDays').value.trim();
    const times = document.getElementById('newSpecTimes').value.trim();
    if (!name || !email) {
      alert('يرجى إدخال اسم وبريد الأخصائي');
      return;
    }
    specialists.push({ name, email, days, times });
    saveSpecs();
    document.getElementById('newSpec').value = '';
    document.getElementById('newSpecEmail').value = '';
    document.getElementById('newSpecDays').value = '';
    document.getElementById('newSpecTimes').value = '';
    alert('تم إضافة الأخصائي وحفظه');
  }
  function deleteSpec(i) {
    if (!confirm('هل تريد حذف هذا الأخصائي؟')) return;
    specialists.splice(i, 1);
    saveSpecs();
  }

  // ===== إدارة المواعيد =====
  function saveAppts() {
    localStorage.setItem('appts', JSON.stringify(appointments));
    renderAppts();
  }
  function renderAppts(list = appointments) {
    const tbody = document.getElementById('apptTableBody');
    tbody.innerHTML = '';
    list.forEach((a, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border p-2">${idx + 1}</td>
        <td class="border p-2">${a.child}</td>
        <td class="border p-2">${a.day}</td>
        <td class="border p-2">${a.time}</td>
        <td class="border p-2">${a.dept}</td>
        <td class="border p-2">${a.sub}</td>
        <td class="border p-2">${a.spec || '-'}</td>
        <td class="border p-2">
          <button class="btn-small" onclick="toggleRepl(${idx})">
            ${a.type === 'تعويض' ? '✔' : 'تعويض'}
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  function addAppt() {
    const child = document.getElementById('childName').value.trim();
    const day = document.getElementById('day').value;
    const time = document.getElementById('timeSlot').value;
    const sub = document.getElementById('subscription').value;
    if (!child) {
      alert('يجب إدخال اسم الطفل');
      return;
    }
    const sameCount = appointments.filter(a => a.day === day && a.time === time).length;
    if (sameCount >= 5) {
      alert('هذه الفترة ممتلئة (5 أطفال بالفعل)');
      return;
    }
    const depts = Array.from(document.querySelectorAll('.dept-chk'))
      .filter(cb => cb.checked).map(cb => cb.value);
    if (!depts.length) {
      alert('اختر قسماً واحدًا على الأقل');
      return;
    }
    depts.forEach(dept => {
      let assigned = '';
      for (const s of specialists) {
        const daysArr = s.days.split(',').map(d => d.trim());
        const timesArr = s.times.split(',').map(t => t.trim());
        if (daysArr.includes(day) && timesArr.includes(time)) {
          assigned = s.name;
          break;
        }
      }
      appointments.push({ child, day, time, dept, sub, spec: assigned, type: 'عادي' });
    });
    document.getElementById('childName').value = '';
    document.querySelectorAll('.dept-chk').forEach(cb => cb.checked = false);
    saveAppts();
    alert('تم إضافة المواعيد وحفظها');
  }
  function toggleRepl(i) {
    appointments[i].type = (appointments[i].type === 'تعويض' ? 'عادي' : 'تعويض');
    saveAppts();
  }
  function filterAppts() {
    const f = document.getElementById('filterSpec').value.trim().toLowerCase();
    renderAppts(appointments.filter(a => a.spec.toLowerCase() === f));
  }

  // ===== إرسال جدول الأخصائي عبر EmailJS =====
  function sendScheduleEmail() {
    const email = document.getElementById('specEmail').value.trim();
    const name = document.getElementById('filterSpec').value.trim();
    if (!email || !name) {
      alert('يرجى إدخال البريد واسم الأخصائي في التصفية');
      return;
    }
    const list = appointments.filter(a => a.spec.toLowerCase() === name.toLowerCase());
    if (!list.length) {
      alert('لا توجد مواعيد لهذا الأخصائي');
      return;
    }
    let html = `<h3 style="background:#059669;color:#fff;padding:10px;border-radius:6px;">
      جدول مواعيد ${name}
    </h3>`;
    html += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse;width:100%;direction:rtl;">`;
    html += `<tr style="background:#F3F4F6;font-weight:bold;">
      <th>طفل</th><th>اليوم</th><th>الوقت</th><th>القسم</th><th>اشتراك</th><th>نوع</th>
    </tr>`;
    list.forEach(a => {
      html += `<tr>
        <td>${a.child}</td>
        <td>${a.day}</td>
        <td>${a.time}</td>
        <td>${a.dept}</td>
        <td>${a.sub}</td>
        <td>${a.type}</td>
      </tr>`;
    });
    html += `</table><br/><p>مع أطيب التمنيات، إدارة المركز</p>`;

    emailjs.send('service_cuzf74k', 'template_b04f8pi', {
      to_name: name,
      to_email: email,
      schedule_html: html
    })
    .then(_ => {
      alert('تم إرسال الجدول بنجاح إلى ' + email);
    })
    .catch(e => {
      alert('خطأ أثناء الإرسال: ' + JSON.stringify(e));
    });
  }
</script>
</body>
</html>
