<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>نظام مواعيد المركز</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CSS (للتنسيق السريع نظيف) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

  <style>
    :root {
      --color-mint: #87C8BC;
      --color-beige: #F5E6C8;
      --color-navy: #1F2F3D;
      --color-light: #FFF9E6;
      --font-base: 'Cairo', sans-serif;
    }
    @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-base);
      background-color: var(--color-light);
      color: var(--color-navy);
      direction: rtl;
      min-height: 100vh;
    }
    header {
      background-color: var(--color-mint);
      padding: 20px; text-align: center;
    }
    header img { height: 60px; vertical-align: middle; }
    header h1 {
      display: inline-block; margin-left: 10px;
      color: #fff; font-size: 24px; font-weight: bold;
      vertical-align: middle;
    }
    main {
      max-width: 1100px; margin: 20px auto; padding: 0 10px;
    }
    h2 {
      font-size: 20px; margin-bottom: 12px;
      border-bottom: 3px solid var(--color-mint);
      display: inline-block; padding-bottom: 5px;
    }
    section {
      background-color: #fff; border-radius: 8px;
      padding: 20px; margin-bottom: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .form-row {
      display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 18px;
    }
    .form-row > * { flex: 1; min-width: 180px; }
    input[type="text"],
    input[type="email"],
    select {
      width: 100%; padding: 8px; border: 1px solid #ccc;
      border-radius: 6px; font-size: 14px; outline: none;
    }
    input[type="text"]:focus,
    input[type="email"]:focus,
    select:focus {
      border-color: var(--color-mint);
      box-shadow: 0 0 0 2px rgba(135,200,188,0.3);
    }
    .checkbox-group {
      display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 12px;
    }
    .checkbox-group label {
      display: flex; align-items: center; gap: 6px; font-weight: normal;
    }
    button {
      background-color: var(--color-mint); color: #fff;
      border: none; border-radius: 6px; padding: 10px 20px;
      font-size: 14px; cursor: pointer; transition: background-color 0.2s;
    }
    button:hover { background-color: var(--color-navy); }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px; text-align: center;
    }
    th, td {
      border: 1px solid #ddd; padding: 10px; font-size: 14px;
    }
    th {
      background-color: var(--color-beige); font-weight: bold;
    }
    tr:nth-child(even) { background-color: var(--color-light); }
    .btn-small {
      background-color: var(--color-beige); color: var(--color-navy);
      padding: 6px 12px; font-size: 12px; border-radius: 4px;
      transition: background-color 0.2s, color 0.2s;
    }
    .btn-small:hover { background-color: var(--color-navy); color: #fff; }
    @media (max-width: 768px) {
      .form-row { flex-direction: column; }
      h2 { font-size: 18px; }
      header h1 { display: block; margin-top: 8px; }
    }
  </style>
</head>
<body>
  <!-- رأس الصفحة -->
  <header>
    <img src="logo.png" alt="شعار المركز" />
    <h1>نظام مواعيد المركز</h1>
  </header>

  <main>
    <!-- ===== 1) إدارة الأخصائيين ===== -->
    <section>
      <h2>1. إدارة الأخصائيين</h2>
      <!-- نموذج إضافة أخصائي جديد -->
      <div class="form-row">
        <div>
          <label for="newSpec">اسم الأخصائي</label>
          <input type="text" id="newSpec" placeholder="مثال: أحمد" />
        </div>
        <div>
          <label for="newSpecEmail">البريد الإلكتروني</label>
          <input type="email" id="newSpecEmail" placeholder="ahmed@example.com" />
        </div>
        <div>
          <label for="newSpecDays">الأيام (مفصولة بفاصلة)</label>
          <input type="text" id="newSpecDays" placeholder="مثال: السبت،الأحد" />
        </div>
        <div>
          <label for="newSpecTimes">الأوقات (مفصولة بفاصلة)</label>
          <input type="text" id="newSpecTimes" placeholder="مثال: 1:00-1:40،1:40-2:20" />
        </div>
        <button onclick="addSpec()">إضافة أخصائي جديد</button>
      </div>
      <button onclick="loadData()" class="btn-small mb-4">🔄 إعادة تحميل البيانات</button>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>الأخصائي</th>
              <th>البريد الإلكتروني</th>
              <th>توافر (أيام)</th>
              <th>توافر (أوقات)</th>
              <th>حذف</th>
            </tr>
          </thead>
          <tbody id="specTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ===== 2) إدخال مواعيد الأطفال ===== -->
    <section>
      <h2>2. إدخال مواعيد الأطفال</h2>
      <div class="form-row">
        <div>
          <label for="childName">اسم الطفل</label>
          <input type="text" id="childName" placeholder="مثال: ليلى" />
        </div>
        <div>
          <label for="day">اليوم</label>
          <select id="day">
            <option>السبت</option><option>الأحد</option><option>الاثنين</option>
            <option>الثلاثاء</option><option>الأربعاء</option><option>الخميس</option>
          </select>
        </div>
        <div>
          <label for="timeSlot">الفترة الزمنية</label>
          <select id="timeSlot">
            <option>1:00 - 1:40</option><option>1:40 - 2:20</option><option>2:20 - 3:00</option>
            <option>3:20 - 4:00</option><option>4:00 - 4:40</option><option>4:40 - 5:20</option>
            <option>5:20 - 6:00</option><option>6:00 - 6:40</option><option>6:40 - 7:20</option>
            <option>7:20 - 8:00</option><option>8:00 - 8:40</option><option>8:40 - 9:20</option>
          </select>
        </div>
        <div>
          <label for="subscription">نوع الاشتراك</label>
          <select id="subscription">
            <option>24 جلسة</option><option>36 جلسة</option><option>48 جلسة</option>
            <option>ساعة اختبار</option><option>ساعتين اختبار</option>
          </select>
        </div>
      </div>
      <div class="checkbox-group">
        <label><input type="checkbox" class="dept-chk" value="تعديل سلوك" /> تعديل سلوك</label>
        <label><input type="checkbox" class="dept-chk" value="تخاطب" /> تخاطب</label>
        <label><input type="checkbox" class="dept-chk" value="تنمية مهارات" /> تنمية مهارات</label>
        <label><input type="checkbox" class="dept-chk" value="جلسة نفسية" /> جلسة نفسية</label>
        <label><input type="checkbox" class="dept-chk" value="اختبار ذكاء" /> اختبار ذكاء</label>
      </div>
      <button onclick="addAppts()">حفظ موعد الطفل</button>
    </section>

    <!-- ===== 3) جدول المواعيد وإرسال البريد ===== -->
    <section>
      <h2>3. جدول المواعيد</h2>
      <div class="form-row mb-4">
        <div>
          <label for="filterSpec">تصفية باسم الأخصائي</label>
          <input type="text" id="filterSpec" placeholder="مثال: أحمد" />
        </div>
        <button onclick="filterAppts()" class="self-end">تصفية</button>
        <button onclick="renderAppts()" class="self-end">عرض الجميع</button>
      </div>
      <div class="form-row mb-4">
        <div>
          <label for="specEmail">البريد الإلكتروني للأخصائي</label>
          <input type="email" id="specEmail" placeholder="ahmed@example.com" />
        </div>
        <button onclick="sendScheduleEmail()" class="self-end">إرسال جدول الأخصائي</button>
      </div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>اسم الطفل</th>
              <th>اليوم</th>
              <th>الوقت</th>
              <th>القسم</th>
              <th>اشتراك</th>
              <th>الأخصائي</th>
              <th>تعويض</th>
            </tr>
          </thead>
          <tbody id="apptTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ===== 1) إعداد Firebase =====
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBinpejpZQv71xxhJrlYcET-uNLPL0pROY",
  authDomain: "ynmo-center-scheduler.firebaseapp.com",
  databaseURL: "https://ynmo-center-scheduler-default-rtdb.firebaseio.com",
  projectId: "ynmo-center-scheduler",
  storageBucket: "ynmo-center-scheduler.firebasestorage.app",
  messagingSenderId: "287665928063",
  appId: "1:287665928063:web:67f6bccd66a25ef0118c4a"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

    // ===== 2) تهيئة EmailJS =====
    emailjs.init('Ol1_k8IqKWQbPcbNv');

    // ===== 3) تحميل البيانات من Firestore وعرضها =====
    let specialists = [];
    let appts = [];

    function loadData() {
      // جلب الأخصائيين من Collection "specialists"
      db.collection('specialists').get().then(snapshot => {
        specialists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderSpecs();
      });
      // جلب المواعيد من Collection "appointments"
      db.collection('appointments').get().then(snapshot => {
        appts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderAppts();
      });
      alert('تم تحميل البيانات من Firestore');
    }

    // عند فتح الصفحة لأول مرة
    window.onload = () => {
      loadData();
    };

    // ===== 4) وظائف إدارة الأخصائيين =====
    function renderSpecs() {
      const tbody = document.getElementById('specTableBody');
      tbody.innerHTML = '';
      specialists.forEach((s, idx) => {
        const tr = document.createElement('tr');
        const days = s.days || '-';
        const times = s.times || '-';
        tr.innerHTML = `
          <td class="border p-2">${idx + 1}</td>
          <td class="border p-2">${s.name}</td>
          <td class="border p-2">${s.email}</td>
          <td class="border p-2">${days}</td>
          <td class="border p-2">${times}</td>
          <td class="border p-2">
            <button onclick="deleteSpec('${s.id}')" class="btn-small">حذف</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function addSpec() {
      const name = document.getElementById('newSpec').value.trim();
      const email = document.getElementById('newSpecEmail').value.trim();
      const days = document.getElementById('newSpecDays').value.trim();
      const times = document.getElementById('newSpecTimes').value.trim();
      if (!name || !email) {
        alert('يرجى إدخال اسم وبريد الأخصائي');
        return;
      }
      // إضافة المستند إلى Firestore
      db.collection('specialists').add({
        name,
        email,
        days,
        times
      }).then(docRef => {
        specialists.push({ id: docRef.id, name, email, days, times });
        renderSpecs();
        // إعادة تعيين الحقول
        document.getElementById('newSpec').value = '';
        document.getElementById('newSpecEmail').value = '';
        document.getElementById('newSpecDays').value = '';
        document.getElementById('newSpecTimes').value = '';
        alert('تم إضافة الأخصائي وحفظه في Firestore');
      }).catch(err => {
        alert('حدث خطأ أثناء الإضافة: ' + err);
      });
    }

    function deleteSpec(id) {
      if (!confirm('هل تريد حذف هذا الأخصائي من النظام؟')) return;
      db.collection('specialists').doc(id).delete().then(() => {
        specialists = specialists.filter(s => s.id !== id);
        renderSpecs();
        alert('تم حذف الأخصائي');
      });
    }

    // ===== 5) وظائف إدارة المواعيد =====
    function renderAppts(list = appts) {
      const tbody = document.getElementById('apptTableBody');
      tbody.innerHTML = '';
      list.forEach((a, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border p-2">${idx + 1}</td>
          <td class="border p-2">${a.child}</td>
          <td class="border p-2">${a.day}</td>
          <td class="border p-2">${a.time}</td>
          <td class="border p-2">${a.dept}</td>
          <td class="border p-2">${a.sub}</td>
          <td class="border p-2">${a.spec || '-'}</td>
          <td class="border p-2">
            <button onclick="toggleRepl('${a.id}')" class="btn-small">
              ${a.type === 'تعويض' ? '✔' : 'تعويض'}
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function addAppts() {
      const child = document.getElementById('childName').value.trim();
      const day = document.getElementById('day').value;
      const time = document.getElementById('timeSlot').value;
      const sub = document.getElementById('subscription').value;
      if (!child) {
        alert('يجب إدخال اسم الطفل');
        return;
      }
      // لا نسمح بأكثر من 5 أطفال لنفس اليوم والوقت:
      const countSameSlot = appts.filter(a => a.day === day && a.time === time).length;
      if (countSameSlot >= 5) {
        alert('هذه الفترة ممتلئة (5 أطفال بالفعل)');
        return;
      }
      // الأقسام المطلوبة
      const depts = Array.from(document.querySelectorAll('.dept-chk'))
        .filter(cb => cb.checked)
        .map(cb => cb.value);
      if (!depts.length) {
        alert('اختر قسماً واحداً على الأقل');
        return;
      }
      // لكل قسم، نبحث أول أخصائي متاح في نفس اليوم + الوقت (من حقل days/times):
      depts.forEach(dept => {
        let assignedSpec = '';
        for (const s of specialists) {
          // إذا حقل s.days يحتوي اليوم و s.times يحتوي الوقت
          if (s.days.split(',').map(d => d.trim()).includes(day) &&
              s.times.split(',').map(t => t.trim()).includes(time)) {
            assignedSpec = s.name;
            break;
          }
        }
        // أضف الموعد إلى Firestore
        db.collection('appointments').add({
          child,
          day,
          time,
          dept,
          sub,
          spec: assignedSpec,
          type: 'عادي'
        }).then(docRef => {
          appts.push({ id: docRef.id, child, day, time, dept, sub, spec: assignedSpec, type: 'عادي' });
          renderAppts();
        }).catch(err => {
          alert('خطأ في حفظ الموعد: ' + err);
        });
      });
      // إعادة تعيين الحقول فورًا كرد فعل
      document.getElementById('childName').value = '';
      document.querySelectorAll('.dept-chk').forEach(cb => cb.checked = false);
      alert('تم إضافة المواعيد إلى Firestore');
    }

    function toggleRepl(id) {
      // تغيير حالة التعويض في Firestore
      const appt = appts.find(a => a.id === id);
      if (!appt) return;
      const newType = (appt.type === 'تعويض') ? 'عادي' : 'تعويض';
      db.collection('appointments').doc(id).update({ type: newType })
        .then(() => {
          appt.type = newType;
          renderAppts();
        })
        .catch(err => {
          alert('خطأ في تحديث التعويض: ' + err);
        });
    }

    function filterAppts() {
      const f = document.getElementById('filterSpec').value.trim().toLowerCase();
      renderAppts(appts.filter(a => a.spec.toLowerCase() === f));
    }

    // ===== 6) إرسال جدول الأخصائي عبر EmailJS =====
    function sendScheduleEmail() {
      const email = document.getElementById('specEmail').value.trim();
      const name = document.getElementById('filterSpec').value.trim();
      if (!email || !name) {
        alert('تأكد من إدخال البريد واسم الأخصائي في التصفية.');
        return;
      }
      const list = appts.filter(a => a.spec.toLowerCase() === name.toLowerCase());
      if (!list.length) {
        alert('لا توجد مواعيد لهذا الأخصائي.');
        return;
      }
      let html = `<h3 style="background:var(--color-mint);color:#fff;padding:10px;border-radius:5px;">
        جدول مواعيد ${name}
      </h3>`;
      html += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse;width:100%;direction:rtl;">`;
      html += `<tr style="background:var(--color-beige);font-weight:bold;">
        <th>طفل</th><th>اليوم</th><th>الوقت</th><th>القسم</th><th>اشتراك</th><th>نوع</th>
      </tr>`;
      list.forEach(a => {
        html += `<tr>
          <td>${a.child}</td>
          <td>${a.day}</td>
          <td>${a.time}</td>
          <td>${a.dept}</td>
          <td>${a.sub}</td>
          <td>${a.type}</td>
        </tr>`;
      });
      html += `</table><br/><p>مع أطيب التمنيات، إدارة المركز</p>`;

      emailjs.send('service_cuzf74k', 'template_b04f8pi', {
        to_name: name,
        to_email: email,
        schedule_html: html
      })
      .then(_ => {
        alert('تم إرسال الجدول بنجاح إلى ' + email);
      })
      .catch(e => {
        alert('حدث خطأ أثناء الإرسال: ' + JSON.stringify(e));
      });
    }
  </script>
</body>
</html>
